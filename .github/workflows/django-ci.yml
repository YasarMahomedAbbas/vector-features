  name: Django CI
  on:                                    
    push:
      branches: ["main"]
    pull_request:
      branches: ["main"]

  jobs:
    lint:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.14"
        - name: Install ruff
          run: pip install ruff
        - name: Run Linter
          run: ruff check .

    build:
      runs-on: ubuntu-latest
      needs: lint
      services:
        postgres:
          image: postgis/postgis:latest
          env:
            POSTGRES_DB: vector_features_db
            POSTGRES_USER: testuser
            POSTGRES_PASSWORD: testpassword
          ports:
            - 5432:5432
          options: >-
            --health-cmd="pg_isready -U testuser -d vector_features_db"
            --health-interval=10s
            --health-timeout=5s
            --health-retries=5
      steps:
        - uses: actions/checkout@v4
        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: "3.14"
        - name: Install system dependencies
          run: sudo apt-get update && sudo apt-get install -y gdal-bin libgdal-dev
        - name: Install dependencies
          run: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
        - name: Run tests
          env:
            POSTGIS_USER: testuser
            POSTGIS_PASSWORD: testpassword
          run: python manage.py test